name: SDK Sync Check

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9am UTC
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install

      # Bump deps to latest
      - name: Bump sarvamai SDK
        run: pnpm add -D sarvamai@latest

      - name: Bump AI SDK provider
        run: pnpm add @ai-sdk/provider@latest @ai-sdk/provider-utils@latest

      # Detect model drift
      - name: Check model sync
        id: sync
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(pnpm exec tsx scripts/sync-models.ts 2>&1)
          CODE=$?
          echo "$OUTPUT"
          echo "drift<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit $CODE

      # Detect type breakage
      - name: Type check
        id: typecheck
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(pnpm run type-check 2>&1)
          CODE=$?
          echo "$OUTPUT"
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit $CODE

      # Get latest versions for context
      - name: Get versions
        if: steps.sync.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        id: versions
        run: |
          echo "sarvamai=$(npm view sarvamai version)" >> $GITHUB_OUTPUT
          echo "provider=$(npm view @ai-sdk/provider version)" >> $GITHUB_OUTPUT
          echo "utils=$(npm view @ai-sdk/provider-utils version)" >> $GITHUB_OUTPUT

      # Skip if issue already exists
      - name: Check existing issues
        if: steps.sync.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list --label auto-update --state open --json number --jq length)
          echo "open_issues=$COUNT" >> $GITHUB_OUTPUT

      # Open issue with full context for Claude Code
      - name: Write issue body
        if: |
          (steps.sync.outcome == 'failure' || steps.typecheck.outcome == 'failure')
          && steps.existing.outputs.open_issues == '0'
        run: |
          cat > /tmp/issue-body.md << 'BODY'
          ## Drift report

          **Latest versions:** sarvamai@SARVAMAI_VER, @ai-sdk/provider@PROVIDER_VER, @ai-sdk/provider-utils@UTILS_VER

          ### Model sync output
          ```
          SYNC_OUTPUT
          ```

          ### Type check output
          ```
          TSC_OUTPUT
          ```

          ---
          This issue was auto-generated by the weekly sync check. The `auto-fix` workflow will attempt to resolve it.
          BODY
          sed -i "s|SARVAMAI_VER|${{ steps.versions.outputs.sarvamai }}|g" /tmp/issue-body.md
          sed -i "s|PROVIDER_VER|${{ steps.versions.outputs.provider }}|g" /tmp/issue-body.md
          sed -i "s|UTILS_VER|${{ steps.versions.outputs.utils }}|g" /tmp/issue-body.md

      - name: Open issue
        if: |
          (steps.sync.outcome == 'failure' || steps.typecheck.outcome == 'failure')
          && steps.existing.outputs.open_issues == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYNC_OUTPUT: ${{ steps.sync.outputs.drift }}
          TSC_OUTPUT: ${{ steps.typecheck.outputs.errors }}
        run: |
          # Replace placeholders with multiline content via env vars
          python3 -c "
          import os
          body = open('/tmp/issue-body.md').read()
          body = body.replace('SYNC_OUTPUT', os.environ.get('SYNC_OUTPUT', 'clean'))
          body = body.replace('TSC_OUTPUT', os.environ.get('TSC_OUTPUT', 'clean'))
          open('/tmp/issue-body.md', 'w').write(body)
          "
          gh issue create \
            --title "SDK drift detected $(date +%Y-%m-%d)" \
            --label "auto-update" \
            --body-file /tmp/issue-body.md
